<html>
<head>
<title>Courbes</title>
<script src="jquery-3.3.1.min.js"></script>
<script src="download.js"></script>
<script src="editabletable.js"></script>
<script>

var data = "";
var imgWidth = 2480, imgHeight = 1748;

var bl = [252, 1415];
var tr = [2085, 203];


function monthToX(month) {
    return bl[0] + (tr[0] - bl[0]) * (month / 60) + 2;
}


function sizeToY(size) {
    return bl[1] + (tr[1] - bl[1]) * ((size - 30) / 30) + 2;
}


// var colorb = "#d2e18c";
// var colorg = "#fdcd80";

var colorb = "#6D9505";
var colorg = "#790463";


function makeHighDpi(canvas, ctx) {
    var dpr = window.devicePixelRatio || 1;
    var bsr = ctx.webkitBackingStorePixelRatio ||
              ctx.mozBackingStorePixelRatio ||
              ctx.msBackingStorePixelRatio ||
              ctx.oBackingStorePixelRatio ||
              ctx.backingStorePixelRatio || 1;
    var pixelRatio = dpr / bsr;
    canvas.pixelRatio = pixelRatio;
    canvas.style.width  = canvas.width  + "px";
    canvas.style.height = canvas.height + "px";
    canvas.width  *= pixelRatio;
    canvas.height *= pixelRatio;
    ctx.scale(pixelRatio, pixelRatio);
}


function Curves() {
    var canvas = document.getElementById("curves");

    if (canvas.getContext) {
        var ctx = canvas.getContext('2d');
        makeHighDpi(canvas, ctx);

        ctx.strokeStyle = colorb;
        ctx.fillStyle = colorb;
        ctx.lineWidth = 1;
        ctx.lineCap = "round";
        ctx.lineJoin = "round";

    }

    this.canvas = canvas;
    this.ctx = ctx;
    this.pixelRatio = canvas.pixelRatio;
}


Curves.prototype.loadImage = function (url, callback) {
    var img = new Image();
    var that = this;
    img.onload = function() {
        var canvas = that.canvas;
        that.ctx.drawImage(img, 0, 0,
                           canvas.width / canvas.pixelRatio,
                           canvas.height / canvas.pixelRatio);

        if (callback !== undefined) {
            callback();
            data = canvas.toDataURL();
        }
    };
    img.src = url;
};


Curves.prototype._rescale = function (x, y) {
    var x2 = (x / imgWidth) * this.canvas.width / this.canvas.pixelRatio;
    var y2 = (y / imgHeight) * this.canvas.height / this.canvas.pixelRatio;
    return [x2, y2];
};


Curves.prototype.drawPath = function (path_orig) {
    var ctx = this.ctx;

    var path = [];
    for (var i = 0; i < path_orig.length; i ++) {
        var coords = path_orig[i];
        var x = coords[0], y = coords[1];
        var coords = this._rescale(x, y);
        path.push(coords);
    }

    // Path.
    ctx.beginPath();
    for (var i = 0; i < path.length; i ++) {
        var coords = path[i];
        ctx.lineTo(coords[0], coords[1]);
    }
    ctx.stroke();
    ctx.closePath();

    // Discs.
    for (var i = 0; i < path.length; i ++) {
        var coords = path[i];
        ctx.beginPath();
        ctx.arc(coords[0], coords[1], 3, 0, 2 * Math.PI, false);
        ctx.fill();
        ctx.closePath();
    }

}

function draw() {
    var curves = new Curves();
    curves.loadImage("hcb.png", function () {
        var coords = [monthToX(24), sizeToY(55)];
        curves.drawPath([bl, coords, tr]);
    });
}

$(document).ready(function() {
    draw();
});


function downloadCanvas() {
    var canvas = document.getElementById("curves");
    console.log(data.length);
    download(data, "courbe.png", "image/png");
}

</script>
<style>
#curves {
    border: 1px solid black;
}
</style>
</head>
<body>

<canvas id="curves" width="620" height="437"></canvas>
<button onclick="downloadCanvas()">Download</button>

</body>
</html>
